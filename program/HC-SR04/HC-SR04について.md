# HC-SR04について

ここではこのラジコンカーに搭載されている測距モジュール，HC-SR04について書いています．

### 概要
HC-SR04は超音波を用いた測距モジュールで超音波の往復時間から対象物までの距離を算出するモジュールです．40kHzの周波数の超音波を出して、それが反射して戻って来るまでの時間から距離を計測するセンサーです。

### データ
[データシート](http://akizukidenshi.com/download/ds/sainsmar/hc-sr04_ultrasonic_module_user_guidejohn_b.pdf)
|　電気的パラメータ　|　データ　|
|:--:|:--:|
|電源入力| 5.0V |
|操作電流|15mA|
|周波数| 40kHz |
|最長測定距離| 400cm(4.0m) |
|最短測定距離| 2.0cm |
|検査角度| 15$^\circ$ |
|シグナル入力時間|10us以上|

データシートから一部抜粋．

#### 測距方法
左がら2番目の「Trig」というのがトリガー（Trigger）である。ここにパルス的に電圧を掛ける．（時間は10μ秒以上）すると2つのスピーカーから40kHzという超音波が8回放たれる。
放出した超音波は対象物に当たりセンサー側に戻り，戻ってきたら、右から2番目の「Echo」というピンにそのかかった時間分電圧が出力される（HIGH状態）．よって，EchoがHIGHになっている時間と音波が空気中を伝わる速さから，その距離が計算できる．

### 距離の計算
戻り値のパルス時間（μ秒単位）から距離を計算する.まず音は1秒間で空気中をおよそ340mで伝わる．この速度は温度など周りの環境で随分と変わってしまう.例えば15度ほどだと340mだが，30度だと349mと9mも変わってししまう．より正確に距離を計測するには，温度をファクターとして入れた方が良い，精度を持たせる際には別の温度モジュールなどを設置し，リアルタイムで温度を取得，適宜音速を算出し計算する．という方法を取るのが最善だと思われる．

### 計算式
計算自体は簡単なものである．
超音波が放出され，反射して戻って来る時間を$t \mu s$とする．1秒($= 1000000 \mu s$)で340m伝わるので．$t\mu s$だと$$\frac{340 m \times t}{1000000}$$で往復の距離(m),その半分で反射したものまでの距離が算出できる．もしこれをcmに直す際には.
$$\frac{340 \times t}{1000000 \times 100} = \frac{340 \times t}{1000} \times \frac{1}{2} = 0.017 \times t$$

この計算式で目標までの距離がcmで算出できる．

### 注意
#### 検査角度について
このモジュールの検査角度は15$^\circ$であり，測定値の誤差がある時がある，最大の4mの時には測定する対象がそのモジュールの直線上から10.826cm右左にずれる．複雑な地形の場合，このようなモジュールよりも精度の高いものを使用したほうがいいと言える．

![](https://i.imgur.com/IFoLGQj.png)

この画像は4.0mの場合の検査角度についての画像である．
左のモジュールから放出された超音波は右の壁までの間を往復する．その際測定誤差は15$^\circ$であるので，距離が測定される範囲は緑色の線を２倍した距離と等しくなる．

ここで緑の部分の長さを求める．この直角三角形の角度は7.5$\circ$．この三角形の高さ$h$を求めるためには，以下の式を解けば良い．

\begin{eqnarray}
  tan7.5 = \frac{4}{h} \\
\end{eqnarray}

これを解くと，以下のようになる．

\begin{eqnarray}
  tan7.5 = \frac{4}{h} \\
  h = 4 \times tan7.5 \\
  h \approx 10.824
\end{eqnarray}
つまり，これを2倍するので，21.648cmの幅で距離が計測されることに気をつけたい．